---
title: "Merging the files"
author: "the free masons"
date: "12/12/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(glue)
library(here)
```

The goal is to have all the various years having the same variable, with the same name, and the same class, in the same order.

```{r}
target_names <- c(
  "country",
  "school_id",
  "student_id",
  "mother_educ",
  "father_educ",
  "gender",
  "computer",
  "internet",
  "math",
  "science",
  "read",
  "stu_wgt")
```


The year 2000 is saved as rds instead of rda. for sake of sanity, we are going to read it in and save it as rda in place.

```{r}

if(!file.exists(here("Data/Output/2000/stu_qqq.rda"))){
  stu_qqq_2000 <- read_rds(here("Data/Output/2000/stu_qqq.rds"))
  save(stu_qqq_2000,file = here("Data/Output/2000/stu_qqq.rda"))
  rm(stu_qqq_2000)
}
```

load all the datasets

```{r}
dfs <- data_frame(
  years = seq(2000, 2018, 3)
) %>%
  mutate(
  paths = glue("Data/Output/{years}/{what}.rda", what = "stu_qqq")
)

df_names <- map_chr(dfs$paths ,~ load(here(.x), envir = .GlobalEnv))

pisa_student_2006 <- pisa_student_2006 %>%
  mutate(CNT = as.character(CNT))
```

```{r}
df_names
```

Year 2000 is particular. Let's see what we have there.

```{r}
stu_qqq_2000 %>% glimpse()
```

We miss a couple of variable regarding mother and father education, and the order of read and science is wrong. Let's do create them and fill them with explicit missing.

```{r}
stu_qqq_2000 <- stu_qqq_2000 %>%
  mutate(
    mother_educ = NA_character_,
    father_educ = NA_character_
  ) %>%
  select(target_names)
```

What have we done?

```{r}
stu_qqq_2000 %>% glimpse()
```

We will need to solve the `country` encoding mismatch, between the three-characters of 2003 to 2018 and the numeric code of 2000. We can use `countrycode` to do the job.

```{r}
stu_qqq_2000 <- stu_qqq_2000 %>%
 mutate(country = country %>%
           as.numeric() %>%
           countrycode(origin = "iso3n", destination = "iso3c"))
```


```{r}
names_2006_2012 <- data_frame(
  target_names =   target_names,
  `2000` = stu_qqq_2000 %>% names(),
  `2003` = d3[,-1] %>% names(),
  `2006` = pisa_student_2006[,-1] %>% names(),
  `2009` = d_sub_2009 %>% names(),
  `2012` = d_sub_2012 %>% names(),
  `2015` = df_temp %>% names(),
  `2018` = stu_qqq_output %>% names()
)
```

Let's see what we have

```{r}
knitr::kable(names_2006_2012)
```

apparently it's quite ok, as long as we shift the order of `stu_wgt` in 2015 and 2018.

```{r}
stu_qqq_output <- stu_qqq_output %>%
  select(-W_FSTUWT, everything())

df_temp <- df_temp %>%
  select(-W_FSTUWT, everything())
```

and now we brute force the name in, remembering that 2003 and 2006 have one extra variable (the numeric code for countries).

```{r}
names(stu_qqq_2000) <- target_names
names(d3) <- c("country_n_code",target_names)
names(pisa_student_2006) <- c("country_n_code",target_names)
names(d_sub_2009) <- target_names
names(d_sub_2012) <- target_names
names(df_temp) <- target_names
names(stu_qqq_output) <- target_names
```

```{r}
list_dfs <- list(
     `2000` = stu_qqq_2000 %>% mutate_all(formatC),
     `2003` = d3[,-1] %>% mutate_all(formatC),
     `2006` = pisa_student_2006[,-1] %>% mutate_all(formatC),
     `2009` = d_sub_2009 %>% mutate_all(formatC),
     `2012` = d_sub_2012 %>% mutate_all(formatC),
     `2015` = df_temp  %>% mutate_all(formatC),
     `2018` = stu_qqq_output  %>% mutate_all(formatC)
     )

rm(list = df_names)
```

Let's bind EVERYTHING together and reinstate a meaningful class scheme.

```{r}
student <- bind_rows(list_dfs, .id = "year") %>%
  mutate(year = as.integer(year)) %>%
  mutate(country = as.factor(country)) %>%
  mutate_at(c("mother_educ", "father_educ", "gender", "computer", "internet"),
              as.integer) %>%
  mutate_at(c("math", "science", "read", "stu_wgt"),
              as.numeric)
```

Let's see if we have something reasonable by taking a quick glimpse at two rows per each year.

```{r}
student %>% group_by(year) %>% sample_n(2)
```

We want the full length country name.

```{r}
student <-student %>%
  mutate(
    country_iso3c = country,
    country.name = country_iso3c %>%
      countrycode(origin = "iso3c",
                  destination = "country.name"),
    un.name.en = country_iso3c %>%
      countrycode(origin = "iso3c",
                  destination = "un.name.en"))
```


Ok, let's write it to file, (both rds and rda compressed).

```{r}
write_rds(student,
          path = here("Data/Output/student.rds"),
          compress = "xz")

save(student,
     file = here("Data/Output/student.rda"))
```


